{% extends 'layout.html' %} 
{% block body %}

<!-- Page Header -->
<section class="page-header">
  <div class="container">
    <div class="page-header-content">
      <span class="page-badge">
        <i class="fas fa-microscope"></i>
        Disease Detection
      </span>
      <h1 class="page-title">Detect Plant Diseases Instantly</h1>
      <p class="page-description">Upload a photo of your plant leaves and get instant AI-powered disease detection with treatment recommendations.</p>
    </div>
  </div>
</section>

<!-- Detection Section -->
<section class="detection-section">
  <div class="container">
    <div class="detection-wrapper">
      <div class="detection-card">
        <div class="detection-header">
          <div class="detection-icon">
            <i class="fas fa-leaf"></i>
          </div>
          <h2 class="detection-title">Upload Plant Image</h2>
          <p class="detection-subtitle">Our AI will analyze your plant and identify any diseases</p>
        </div>
        
        <form method="post" enctype="multipart/form-data" class="detection-form" onsubmit="return validateForm(event)">
          {% if error %}
          <div class="error-message-modern">
            <i class="fas fa-exclamation-triangle"></i>
            <span>{{ error }}</span>
          </div>
          {% endif %}
          
          <div class="form-group-modern">
            <label class="form-label-modern">
              <i class="fas fa-camera"></i>
              Select Plant Image
            </label>
            
            <!-- Mode Toggle -->
            <div class="input-mode-toggle">
              <button type="button" class="mode-btn active" id="uploadModeBtn" onclick="switchMode('upload')">
                <i class="fas fa-upload"></i>
                Upload File
              </button>
              <button type="button" class="mode-btn" id="cameraModeBtn" onclick="switchMode('camera')">
                <i class="fas fa-camera"></i>
                Use Camera
              </button>
            </div>
            
            <!-- File Upload Mode -->
            <div class="file-input-wrapper" id="uploadMode">
              <input type="file" name="file" class="file-input-modern" id="inputfile" accept="image/*" onchange="preview_image(event)" />
              <label for="inputfile" class="file-label-modern">
                <i class="fas fa-folder-open"></i>
                <span class="file-text">Choose Image File</span>
                <span class="file-hint">PNG, JPG, JPEG up to 10MB</span>
              </label>
            </div>
            
            <!-- Camera Mode -->
            <div class="camera-wrapper" id="cameraMode" style="display: none;">
              <div class="camera-container">
                <video id="video" autoplay playsinline style="width: 100%; max-width: 500px; border-radius: 8px; display: none;"></video>
                <canvas id="canvas" style="display: none;"></canvas>
                <div class="camera-controls">
                  <button type="button" class="btn-camera-start" id="startCameraBtn" onclick="startCamera()">
                    <i class="fas fa-video"></i>
                    Start Camera
                  </button>
                  <button type="button" class="btn-camera-capture" id="captureBtn" onclick="captureImage()" style="display: none;">
                    <i class="fas fa-camera"></i>
                    Capture Photo
                  </button>
                  <button type="button" class="btn-camera-stop" id="stopCameraBtn" onclick="stopCamera()" style="display: none;">
                    <i class="fas fa-stop"></i>
                    Stop Camera
                  </button>
                  <button type="button" class="btn-camera-retake" id="retakeBtn" onclick="retakePhoto()" style="display: none;">
                    <i class="fas fa-redo"></i>
                    Retake
                  </button>
                </div>
                <div id="cameraError" class="error-message-modern" style="display: none;"></div>
              </div>
            </div>
          </div>
          
          <div class="image-preview-wrapper" id="previewWrapper" style="display: none;">
            <div class="preview-label">
              <i class="fas fa-eye"></i>
              Image Preview
            </div>
            <img id="output-image" class="preview-image-large" />
          </div>
          
          <button type="submit" class="btn-submit-modern">
            <i class="fas fa-search"></i>
            <span>Detect Disease</span>
            <i class="fas fa-arrow-right"></i>
          </button>
        </form>
      </div>
      
      <!-- Info Card -->
      <div class="info-card">
        <h3 class="info-title">
          <i class="fas fa-info-circle"></i>
          What We Detect
        </h3>
        <div class="disease-list">
          <div class="disease-category">
            <h4 class="category-title">
              <i class="fas fa-apple-alt"></i>
              Apple Diseases
            </h4>
            <ul class="disease-items">
              <li>Apple Scab</li>
              <li>Black Rot</li>
              <li>Cedar Apple Rust</li>
            </ul>
          </div>
          <div class="disease-category">
            <h4 class="category-title">
              <i class="fas fa-pepper-hot"></i>
              Tomato Diseases
            </h4>
            <ul class="disease-items">
              <li>Early Blight</li>
              <li>Late Blight</li>
              <li>Bacterial Spot</li>
              <li>Leaf Mold</li>
            </ul>
          </div>
          <div class="disease-category">
            <h4 class="category-title">
              <i class="fas fa-seedling"></i>
              Corn & Potato
            </h4>
            <ul class="disease-items">
              <li>Common Rust</li>
              <li>Northern Leaf Blight</li>
              <li>Early Blight</li>
            </ul>
          </div>
        </div>
        
        <div class="info-tips">
          <h4 class="tips-title">
            <i class="fas fa-star"></i>
            Best Practices
          </h4>
          <ul class="tips-list">
            <li>Use clear, well-lit images</li>
            <li>Focus on affected leaves</li>
            <li>Include multiple angles if possible</li>
            <li>Ensure good image quality</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Benefits Section -->
<section class="benefits-section">
  <div class="container">
    <div class="benefits-grid">
      <div class="benefit-item">
        <i class="fas fa-bolt"></i>
        <h3>Instant Results</h3>
        <p>Get disease detection results in seconds, not days</p>
      </div>
      <div class="benefit-item">
        <i class="fas fa-shield-alt"></i>
        <h3>Early Detection</h3>
        <p>Catch diseases early before they spread to your entire crop</p>
      </div>
      <div class="benefit-item">
        <i class="fas fa-pills"></i>
        <h3>Treatment Guide</h3>
        <p>Receive specific treatment recommendations for each disease</p>
      </div>
      <div class="benefit-item">
        <i class="fas fa-chart-line"></i>
        <h3>Save Costs</h3>
        <p>Reduce crop loss and minimize treatment expenses</p>
      </div>
    </div>
  </div>
</section>

<script type="text/javascript">
  let stream = null;
  let currentMode = 'upload';
  let capturedImageBlob = null;

  // Mode switching
  function switchMode(mode) {
    currentMode = mode;
    const uploadMode = document.getElementById('uploadMode');
    const cameraMode = document.getElementById('cameraMode');
    const uploadBtn = document.getElementById('uploadModeBtn');
    const cameraBtn = document.getElementById('cameraModeBtn');
    const inputfile = document.getElementById('inputfile');
    
    if (mode === 'upload') {
      uploadMode.style.display = 'block';
      cameraMode.style.display = 'none';
      uploadBtn.classList.add('active');
      cameraBtn.classList.remove('active');
      inputfile.required = true;
      stopCamera(); // Stop camera if running
    } else {
      uploadMode.style.display = 'none';
      cameraMode.style.display = 'block';
      uploadBtn.classList.remove('active');
      cameraBtn.classList.add('active');
      inputfile.required = false;
      inputfile.value = ''; // Clear file input
      hidePreview();
    }
  }

  // Start camera
  async function startCamera() {
    const video = document.getElementById('video');
    const startBtn = document.getElementById('startCameraBtn');
    const captureBtn = document.getElementById('captureBtn');
    const stopBtn = document.getElementById('stopCameraBtn');
    const errorDiv = document.getElementById('cameraError');
    
    errorDiv.style.display = 'none';
    
    try {
      // Request camera access with constraints
      // Prefer facingMode: 'environment' (back camera) for mobile, fallback to 'user' (front camera)
      const constraints = {
        video: {
          facingMode: { ideal: 'environment' }, // Back camera preferred
          width: { ideal: 1280 },
          height: { ideal: 720 }
        }
      };
      
      stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;
      video.style.display = 'block';
      
      startBtn.style.display = 'none';
      captureBtn.style.display = 'inline-block';
      stopBtn.style.display = 'inline-block';
      
      // Wait for video to be ready
      video.onloadedmetadata = () => {
        video.play();
      };
    } catch (error) {
      console.error('Error accessing camera:', error);
      errorDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> <span>Unable to access camera. Please check permissions or try uploading a file instead.</span>';
      errorDiv.style.display = 'block';
      
      // If getUserMedia is not supported
      if (error.name === 'NotAllowedError') {
        errorDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> <span>Camera permission denied. Please allow camera access in your browser settings.</span>';
      } else if (error.name === 'NotFoundError') {
        errorDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> <span>No camera found. Please use file upload instead.</span>';
      }
    }
  }

  // Stop camera
  function stopCamera() {
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
      stream = null;
    }
    
    const video = document.getElementById('video');
    const startBtn = document.getElementById('startCameraBtn');
    const captureBtn = document.getElementById('captureBtn');
    const stopBtn = document.getElementById('stopCameraBtn');
    const retakeBtn = document.getElementById('retakeBtn');
    
    video.srcObject = null;
    video.style.display = 'none';
    startBtn.style.display = 'inline-block';
    captureBtn.style.display = 'none';
    stopBtn.style.display = 'none';
    retakeBtn.style.display = 'none';
  }

  // Capture image from camera
  function captureImage() {
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const captureBtn = document.getElementById('captureBtn');
    const stopBtn = document.getElementById('stopCameraBtn');
    const retakeBtn = document.getElementById('retakeBtn');
    
    // Set canvas dimensions to match video
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    
    // Draw video frame to canvas
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    // Convert canvas to blob
    canvas.toBlob(function(blob) {
      capturedImageBlob = blob;
      
      // Create a File object from the blob
      const file = new File([blob], 'captured-image.jpg', { type: 'image/jpeg' });
      
      // Create a FileList-like object and assign to file input
      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(file);
      document.getElementById('inputfile').files = dataTransfer.files;
      
      // Show preview
      const output = document.getElementById('output-image');
      const wrapper = document.getElementById('previewWrapper');
      output.src = canvas.toDataURL('image/jpeg');
      wrapper.style.display = 'block';
      
      // Update button visibility
      captureBtn.style.display = 'none';
      stopBtn.style.display = 'none';
      retakeBtn.style.display = 'inline-block';
      
      // Stop camera stream
      stopCamera();
    }, 'image/jpeg', 0.95);
  }

  // Retake photo
  function retakePhoto() {
    capturedImageBlob = null;
    document.getElementById('inputfile').value = '';
    hidePreview();
    startCamera();
  }

  // Hide preview
  function hidePreview() {
    const wrapper = document.getElementById('previewWrapper');
    wrapper.style.display = 'none';
  }

  // Preview uploaded image
  function preview_image(event) {
    if (event.target.files && event.target.files[0]) {
      var reader = new FileReader();
      reader.onload = function () {
        var output = document.getElementById('output-image');
        var wrapper = document.getElementById('previewWrapper');
        output.src = reader.result;
        wrapper.style.display = 'block';
      }
      reader.readAsDataURL(event.target.files[0]);
    }
  }

  // Form validation
  function validateForm(event) {
    const inputfile = document.getElementById('inputfile');
    const hasFile = inputfile.files && inputfile.files.length > 0;
    
    if (!hasFile) {
      event.preventDefault();
      alert('Please upload an image file or capture a photo using the camera.');
      return false;
    }
    
    return true;
  }

  // Clean up camera stream when page unloads
  window.addEventListener('beforeunload', function() {
    stopCamera();
  });
</script>

{% endblock %}
